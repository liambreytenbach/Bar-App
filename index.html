<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bar Wallet ‚Äì Merchant Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0f0f;
            color: #eaeaea;
            display: flex;
            justify-content: center;
            padding: 2rem;
            margin: 0;
        }

        .container {
            background-color: #101616;
            border-radius: 16px;
            padding: 2rem;
            width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            text-align: center;
            position: relative;
        }

        h1, h2 {
            margin-bottom: 0.5rem;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border: none;
            border-radius: 8px;
            background-color: #1a2020;
            color: #eaeaea;
            outline: none;
        }

        button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

            button.primary {
                background-color: #00bfa6;
                color: white;
            }

                button.primary:hover {
                    background-color: #00d1b4;
                }

            button.secondary {
                background-color: #1f2b2b;
                color: #ccc;
            }

                button.secondary:hover {
                    background-color: #2a3838;
                }

        .hidden {
            display: none;
        }

        .section-box {
            margin-top: 15px;
            text-align: left;
        }

        .toggle-password {
            cursor: pointer;
            position: absolute;
            right: 10px;
            color: #aaa;
        }

        .password-container {
            position: relative;
        }

        #userInfo, #bartendersList, #logBox, .updateLog {
            background-color: #1a2020;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        #logBox, .updateLog {
            border: 1px solid #1f2b2b;
            font-size: 0.8rem;
            max-height: 120px;
            overflow-y: auto;
            text-align: left;
        }

        #signOutBtn {
            position: sticky;
            bottom: 0;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bar Wallet</h1>
        <p>Sign in to manage your merchant account</p>

        <!-- Sign-In Box -->
        <div id="signinBox">
            <input type="email" id="email" placeholder="Email" />
            <div class="password-container">
                <input type="password" id="password" placeholder="Password" />
                <span id="togglePassword" class="toggle-password">üëÅÔ∏è</span>
            </div>
            <button id="signinBtn" class="primary">Sign in</button>
            <div id="logBox"></div>
            <button id="showSignupBtn" class="secondary">Merchant Signup</button>
        </div>

        <!-- Merchant Signup -->
        <div id="merchantSignupBox" class="section-box hidden">
            <h2>Merchant Signup</h2>
            <input type="email" id="merchantEmail" placeholder="Email" />
            <div class="password-container">
                <input type="password" id="merchantPassword" placeholder="Password" />
                <span id="toggleMerchantPassword" class="toggle-password">üëÅÔ∏è</span>
            </div>
            <div class="password-container">
                <input type="password" id="merchantConfirmPassword" placeholder="Confirm Password" />
                <span id="toggleMerchantConfirmPassword" class="toggle-password">üëÅÔ∏è</span>
            </div>
            <input type="text" id="merchantRestaurantName" placeholder="Restaurant Name" />
            <input type="text" id="merchantLocation" placeholder="Location" />
            <input type="text" id="merchantPhone" placeholder="Phone" />
            <input type="text" id="merchantHours" placeholder="Opening Hours" />
            <input type="text" id="merchantDescription" placeholder="Restaurant Description" />
            <input type="text" id="merchantImageUrl" placeholder="Image URL" />
            <button id="merchantSignupBtn" class="primary">Sign Up as Merchant</button>
            <button id="backToLoginBtn" class="secondary">Back to Login</button>
            <div id="merchantSignupLog" class="updateLog"></div>
        </div>

        <!-- Merchant Dashboard -->
        <div id="merchantDashboard" class="hidden section-box">
            <div id="userInfo"></div>

            <h2>Restaurant Info</h2>
            <div id="restaurantInfo">
                <input type="text" id="rName" placeholder="Name" />
                <input type="text" id="rLocation" placeholder="Location" />
                <input type="text" id="rPhone" placeholder="Phone" />
                <input type="text" id="rHours" placeholder="Hours" />
                <input type="text" id="rDescription" placeholder="Description" />
                <input type="text" id="rImageUrl" placeholder="Image URL" />
                <input type="number" id="rRevenue" placeholder="Revenue" />
                <input type="number" id="rTip" placeholder="Tip" />
                <button id="updateRestaurantBtn" class="primary">Update Restaurant</button>
            </div>

            <h2>Bartenders</h2>
            <div class="section-box">
                <input type="text" id="newBartender" placeholder="Add bartender name" />
                <button id="addBartenderBtn" class="primary">Add Bartender</button>
                <div id="bartendersList"></div>
            </div>

            <button id="signOutBtn" class="secondary">Sign Out</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, updateDoc, arrayUnion, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQ5oYWyRiWbXM5IMqd3Y9U0ycPGtNkrEM",
            authDomain: "bar-wallet.firebaseapp.com",
            projectId: "bar-wallet"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const logBox = document.getElementById("logBox");
        const merchantSignupLog = document.getElementById("merchantSignupLog");

        const log = (msg, type = "info") => {
            const color = type === "error" ? "#ff4b4b" : type === "success" ? "#00d084" : "#00bfa6";
            logBox.innerHTML += `<div><strong style="color:${color}">[${type.toUpperCase()}]</strong> ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        };

        // Toggle password
        ["password", "merchantPassword", "merchantConfirmPassword"].forEach(id => {
            const input = document.getElementById(id);
            const toggle = document.getElementById(id === "password" ? "togglePassword" : id === "merchantPassword" ? "toggleMerchantPassword" : "toggleMerchantConfirmPassword");
            toggle.addEventListener("click", () => { input.type = input.type === "password" ? "text" : "password"; toggle.textContent = input.type === "password" ? "üëÅÔ∏è" : "üôà"; });
        });

        // Show/hide signup
        document.getElementById("showSignupBtn").addEventListener("click", () => {
            document.getElementById("signinBox").classList.add("hidden");
            document.getElementById("merchantSignupBox").classList.remove("hidden");
        });
        document.getElementById("backToLoginBtn").addEventListener("click", () => {
            document.getElementById("merchantSignupBox").classList.add("hidden");
            document.getElementById("signinBox").classList.remove("hidden");
        });

        // Fetch restaurant document by merchantEmail
        async function getRestaurantDoc(email) {
            const q = query(collection(db, "Restaurants"), where("merchantEmail", "==", email));
            const snapshot = await getDocs(q);
            return snapshot.docs[0]; // null if none
        }

        // Load restaurant info
        async function loadRestaurant(email) {
            const docSnap = await getRestaurantDoc(email);
            if (docSnap) {
                const data = docSnap.data();
                document.getElementById("rName").value = data.name || "";
                document.getElementById("rLocation").value = data.location || "";
                document.getElementById("rPhone").value = data.phone || "";
                document.getElementById("rHours").value = data.hours || "";
                document.getElementById("rDescription").value = data.description || "";
                document.getElementById("rImageUrl").value = data.imageUrl || "";
                document.getElementById("rRevenue").value = data.revenue || 0;
                document.getElementById("rTip").value = data.tip || 0;
                document.getElementById("bartendersList").innerHTML = (data.bartenders || []).map(b => `<div>${b}</div>`).join("");
            } else {
                await setDoc(doc(collection(db, "Restaurants")), {
                    merchantEmail: email, name: "", location: "", phone: "", hours: "", description: "", imageUrl: "", revenue: 0, tip: 0, bartenders: []
                });
                loadRestaurant(email);
            }
        }

        // Sign In
        document.getElementById("signinBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            if (!email || !password) return log("Enter email & password", "error");
            try {
                const cred = await signInWithEmailAndPassword(auth, email, password);
                log(`Signed in as ${cred.user.email}`, "success");
                document.getElementById("signinBox").classList.add("hidden");
                document.getElementById("merchantSignupBox").classList.add("hidden");
                document.getElementById("merchantDashboard").classList.remove("hidden");
                loadRestaurant(email);
            } catch (e) { log("Sign in failed: " + e.message, "error"); }
        });

        // Merchant Signup
        document.getElementById("merchantSignupBtn").addEventListener("click", async () => {
            const email = document.getElementById("merchantEmail").value.trim();
            const password = document.getElementById("merchantPassword").value.trim();
            const confirm = document.getElementById("merchantConfirmPassword").value.trim();
            const name = document.getElementById("merchantRestaurantName").value.trim();
            if (!email || !password || !confirm || !name) return merchantSignupLog.innerHTML = "Fill all required fields!";
            if (password !== confirm) return merchantSignupLog.innerHTML = "Passwords do not match!";
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(collection(db, "Restaurants")), { merchantEmail: email, name, location: "", phone: "", hours: "", description: "", imageUrl: "", revenue: 0, tip: 0, bartenders: [] });
                document.getElementById("merchantSignupBox").classList.add("hidden");
                document.getElementById("merchantDashboard").classList.remove("hidden");
                loadRestaurant(email);
            } catch (e) { merchantSignupLog.innerHTML = "Signup failed: " + e.message; }
        });

        // Update Restaurant
        document.getElementById("updateRestaurantBtn").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return log("Not signed in", "error");
            const docSnap = await getRestaurantDoc(user.email);
            if (!docSnap) return log("No restaurant doc found", "error");

            const updates = {
                name: document.getElementById("rName").value,
                location: document.getElementById("rLocation").value,
                phone: document.getElementById("rPhone").value,
                hours: document.getElementById("rHours").value,
                description: document.getElementById("rDescription").value,
                imageUrl: document.getElementById("rImageUrl").value,
                revenue: Number(document.getElementById("rRevenue").value),
                tip: Number(document.getElementById("rTip").value)
            };
            if (!docSnap.data().bartenders) updates.bartenders = [];

            await updateDoc(docSnap.ref, updates);
            log("Restaurant info updated", "success");
            loadRestaurant(user.email);
        });

        // Add Bartender
        document.getElementById("addBartenderBtn").addEventListener("click", async () => {
            const user = auth.currentUser;
            const name = document.getElementById("newBartender").value.trim();
            if (!user || !name) return log("Enter bartender name", "error");

            const docSnap = await getRestaurantDoc(user.email);
            if (!docSnap) return log("No restaurant doc found", "error");

            let bartendersArray = docSnap.data().bartenders || [];
            if (!bartendersArray.includes(name)) {
                bartendersArray.push(name);
                await updateDoc(docSnap.ref, { bartenders: bartendersArray });
            }

            document.getElementById("newBartender").value = "";
            loadRestaurant(user.email); // Refresh list
        });

        // Sign Out
        document.getElementById("signOutBtn").addEventListener("click", async () => {
            await signOut(auth);
            document.getElementById("merchantDashboard").classList.add("hidden");
            document.getElementById("signinBox").classList.remove("hidden");
            logBox.innerHTML = "";
        });
    </script>
</body>
</html>

